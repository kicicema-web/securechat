name: Build and Release

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]

env:
  CARGO_TERM_COLOR: always

jobs:
  # Build and test Rust core
  test-core:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-action@stable
    
    - name: Cache cargo
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          core/target/
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
    
    - name: Run tests
      working-directory: ./core
      run: cargo test --verbose
    
    - name: Build release
      working-directory: ./core
      run: cargo build --release --verbose

  # Build desktop app for Linux
  build-linux:
    runs-on: ubuntu-latest
    needs: test-core
    steps:
    - uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.0-dev libappindicator3-dev librsvg2-dev patchelf
    
    - name: Install Rust
      uses: dtolnay/rust-action@stable
    
    - name: Install Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Install Tauri CLI
      run: cargo install tauri-cli
    
    - name: Build desktop app
      working-directory: ./desktop
      run: |
        npm install
        cargo tauri build
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: securechat-linux
        path: desktop/src-tauri/target/release/bundle/appimage/*.AppImage

  # Build desktop app for Windows
  build-windows:
    runs-on: windows-latest
    needs: test-core
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-action@stable
    
    - name: Install Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Install Tauri CLI
      run: cargo install tauri-cli
    
    - name: Build desktop app
      working-directory: ./desktop
      run: |
        npm install
        cargo tauri build
      shell: cmd
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: securechat-windows
        path: desktop/src-tauri/target/release/bundle/msi/*.msi

  # Build Android app
  build-android:
    runs-on: ubuntu-latest
    needs: test-core
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
    
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
    
    - name: Cache Gradle
      uses: actions/cache@v3
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
    
    - name: Build Android app
      working-directory: ./android
      run: ./gradlew assembleRelease
    
    - name: Sign APK (requires signing key)
      if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
      working-directory: ./android
      run: |
        # Sign APK - requires SIGNING_KEY, ALIAS, KEY_STORE_PASSWORD, KEY_PASSWORD secrets
        echo "Signing APK would happen here with secrets"
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: securechat-android
        path: android/app/build/outputs/apk/release/*.apk

  # Create GitHub Release
  release:
    runs-on: ubuntu-latest
    needs: [build-linux, build-windows, build-android]
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
    steps:
    - uses: actions/checkout@v4
    
    - name: Download all artifacts
      uses: actions/download-artifact@v4
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          securechat-linux/*.AppImage
          securechat-windows/*.msi
          securechat-android/*.apk
        generate_release_notes: true
        prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
